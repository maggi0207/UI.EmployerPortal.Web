@page "/employer-registration/business-information"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using UI.EmployerPortal.Razor.SharedComponents.Address
@using UI.EmployerPortal.Razor.SharedComponents.Validation
@using UI.EmployerPortal.Web.Features.Shared.Registrations.Models
@using UI.EmployerPortal.Razor.SharedComponents.Inputs
@inject NavigationManager Nav

<PageTitle>Business Information</PageTitle>

<div class="page_wrapper">
    <div class="bi-page-content">

        <h1 class="page-title">Business Information</h1>
        <p class="page-subtitle">All fields are required unless noted</p>

        <EditForm EditContext="@editContext"
                  FormName="BusinessInformation">

            <DataAnnotationsValidator />
            <CustomValidator @ref="customValidator" />

            @* Top Error Banner *@
            @if (formSubmitted && hasValidationErrors)
            {
                <div class="bi-error-banner">
                    <span class="bi-error-icon">&#9432;</span>
                    <span><strong>Missing information:</strong> Please correct the errors below</span>
                </div>
            }

            @* ================= BUSINESS DETAILS ================= *@
            <div class="bi-fields-grid">

                <div class="bi-field">
                    <FEINField @bind-Value="Model.FEIN"
                               For="() => Model.FEIN"
                               Visible="formSubmitted" />
                    <FieldError For="@(() => Model.FEIN)" Visible="formSubmitted" />
                </div>

                <div class="bi-field"></div>

                <div class="bi-field">
                    <OutlinedTextField Label="Legal Name"
                                       @bind-Value="Model.LegalName"
                                       For="() => Model.LegalName"
                                       Visible="formSubmitted" />
                    <FieldError For="@(() => Model.LegalName)" Visible="formSubmitted" />
                </div>

                <div class="bi-field">
                    <OutlinedTextField Label="Trade Name (Optional)"
                                       @bind-Value="Model.TradeName" />
                </div>

                <div class="bi-field">
                    <PhoneNumberField @bind-Value="Model.PhoneNumber"
                                      For="() => Model.PhoneNumber"
                                      Visible="formSubmitted" />
                    <FieldError For="@(() => Model.PhoneNumber)" Visible="formSubmitted" />
                </div>

                <div class="bi-field">
                    <OutlinedTextField Label="Email Address"
                                       Type="email"
                                       @bind-Value="Model.Email"
                                       For="() => Model.Email"
                                       FormatText="Format: name@example.com"
                                       Visible="formSubmitted" />
                    <FieldError For="@(() => Model.Email)" Visible="formSubmitted" />
                </div>

            </div>

            @* ================= MAILING ADDRESS ================= *@
            <div class="bi-section-header">
                <span>Business Mailing Address</span>
            </div>

            <AddressField Address="Model.MailingAddress"
                          Visible="formSubmitted" />

            @* ================= PHYSICAL LOCATIONS ================= *@
            @for (int i = 0; i < Model.PhysicalLocations.Count; i++)
            {
                var index = i;
                <div class="bi-section-header">
                    <span>Physical Location @(index + 1)</span>
                    @if (index > 0)
                    {
                        <button type="button" class="bi-remove-location" @onclick="() => RemovePhysicalLocation(index)">
                            Remove
                        </button>
                    }
                </div>

                <AddressField Address="Model.PhysicalLocations[index]"
                              Visible="formSubmitted" />
            }

            @* ================= ADD LOCATION BUTTON ================= *@
            @if (Model.PhysicalLocations.Count < MaxPhysicalLocations)
            {
                <button type="button" class="bi-add-location" @onclick="AddPhysicalLocation">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 3V13M3 8H13"
                              stroke="#0D6EFD"
                              stroke-width="2"
                              stroke-linecap="round" />
                    </svg>
                    Add Another Physical Location
                </button>
            }

            @* ================= ACTION BUTTONS ================= *@
            <div class="bi-button-row">

                <div class="bi-button-row-left">
                    <button type="button"
                            class="btn btn--secondary"
                            @onclick="GoBack">
                        <svg width="8" height="13" viewBox="0 0 8 13" fill="none">
                            <path d="M7 1L1 6.5L7 12"
                                  stroke="#003663"
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round" />
                        </svg>
                        BACK
                    </button>
                </div>

                <div class="bi-button-row-right">
                    <button type="button"
                            class="btn btn--tertiary"
                            @onclick="HandleSaveQuit">
                        SAVE &amp; QUIT
                    </button>

                    <button type="button"
                            class="btn btn--primary"
                            @onclick="HandleContinue">
                        CONTINUE
                        <svg width="8" height="13" viewBox="0 0 8 13" fill="none">
                            <path d="M1 1L7 6.5L1 12"
                                  stroke="white"
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>

            </div>

        </EditForm>
    </div>
</div>

@code {
    private BusinessInformationModel Model = new();
    private EditContext editContext = default!;
    private CustomValidator? customValidator;
    private bool formSubmitted = false;
    private bool hasValidationErrors = false;
    private const int MaxPhysicalLocations = 3;

    protected override void OnInitialized()
    {
        editContext = new EditContext(Model);
        editContext.OnFieldChanged += (_, __) =>
        {
            hasValidationErrors = editContext.GetValidationMessages().Any();
            StateHasChanged();
        };
    }

    private void HandleContinue()
    {
        formSubmitted = true;
        customValidator?.ClearErrors();

        // Validate top-level model fields (Business Details)
        var isTopLevelValid = editContext.Validate();

        // Validate nested address models (Mailing + Physical Locations)
        var addressErrors = ValidateAddressModels();
        if (addressErrors.Any())
        {
            customValidator?.DisplayErrors(addressErrors);
            isTopLevelValid = false;
        }

        hasValidationErrors = !isTopLevelValid;

        if (isTopLevelValid)
        {
            Nav.NavigateTo("/address-correction");
        }

        StateHasChanged();
    }

    private Dictionary<FieldIdentifier, List<string>> ValidateAddressModels()
    {
        var errors = new Dictionary<FieldIdentifier, List<string>>();

        // Validate mailing address + all physical locations
        var allAddresses = new List<AddressModel> { Model.MailingAddress };
        allAddresses.AddRange(Model.PhysicalLocations);

        foreach (var address in allAddresses)
        {
            var ctx = new ValidationContext(address);
            var results = new List<ValidationResult>();
            Validator.TryValidateObject(address, ctx, results, true);

            foreach (var result in results)
            {
                foreach (var memberName in result.MemberNames)
                {
                    var fi = new FieldIdentifier(address, memberName);
                    if (!errors.ContainsKey(fi))
                        errors[fi] = new List<string>();
                    errors[fi].Add(result.ErrorMessage ?? "This field is invalid.");
                }
            }
        }

        return errors;
    }

    private void AddPhysicalLocation()
    {
        if (Model.PhysicalLocations.Count < MaxPhysicalLocations)
        {
            Model.PhysicalLocations.Add(new AddressModel());
            StateHasChanged();
        }
    }

    private void RemovePhysicalLocation(int index)
    {
        if (Model.PhysicalLocations.Count > 1 && index >= 0 && index < Model.PhysicalLocations.Count)
        {
            Model.PhysicalLocations.RemoveAt(index);
            customValidator?.ClearErrors();
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("employer-registration/ownership");
    }

    private void HandleSaveQuit()
    {
        Nav.NavigateTo("/dashboard");
    }
}
